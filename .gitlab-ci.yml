image: registry.gitlab.com/faidide/juce-test-01/kholors-builder:v0.1.2

cache:
  - key: juce
    paths:
      - JUCE/
  - key: $CI_COMMIT_REF_SLUG
    paths:
      - .cache
      - build

before_script:
  - if [[ ! -d ./JUCE ]]; then git clone --depth 1 --branch 7.0.2 https://github.com/juce-framework/JUCE.git ; fi
  - if [[ ! -d ./build ]]; then mkdir build ; fi
  - cd build
  - cmake ..

stages:
  - build
  - test
  - versionning

build:
  stage: build
  script:
    - make
  except:
    refs:
      - tags

test:
  stage: test
  script:
    - ctest --output-on-failure
  except:
    refs:
      - tags

versionning:
  image: node:latest
  stage: versionning
  before_script: []
  only:
    refs:
      - master
  script:
    - npm install @semantic-release/gitlab
    - npx semantic-release
